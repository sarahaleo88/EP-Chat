# Service Worker Security Notes

> **Purpose**: Document security considerations for the PWA service worker files.
>
> **Last Updated**: 2025-12-04
> **Related Alerts**: CodeQL #127, #128

---

## Overview

EP-Chat uses [Workbox](https://developer.chrome.com/docs/workbox/) for PWA service worker functionality. The service worker files are:

- `public/sw.js` - Main service worker (Workbox-generated)
- `public/workbox-58cdce56.js` - Workbox runtime library

These files are **generated by Workbox**, not hand-written. Direct modification is not recommended as changes will be overwritten during regeneration.

---

## CodeQL Alerts

### Alert #127: Missing Origin Check in postMessage Handler

**Location**: `public/workbox-58cdce56.js`

**Issue**: The Workbox library's message handler doesn't explicitly check `event.origin` before processing messages.

**Risk Level**: Low

**Mitigation**:
1. The service worker only processes specific message types (`CACHE_URLS`)
2. Service workers are same-origin by design
3. The handler validates message structure before processing

**Recommendation**: This is a known limitation of Workbox. For enhanced security:
- Ensure CSP headers restrict script sources
- Monitor for Workbox updates that address this
- Consider custom service worker if strict origin checking is required

### Alert #128: Remote Property Injection (Prototype Pollution)

**Location**: `public/workbox-58cdce56.js`

**Issue**: The minified Workbox code uses patterns that CodeQL flags as potential prototype pollution vectors.

**Risk Level**: Low

**Mitigation**:
1. Workbox is a widely-used, Google-maintained library
2. The flagged patterns are standard JavaScript operations
3. No user input directly reaches these code paths

**Recommendation**: 
- Keep Workbox updated to latest version
- Monitor Workbox security advisories
- The current version (6.5.4) has no known prototype pollution vulnerabilities

---

## Regenerating Service Worker

If you need to regenerate the service worker with custom security settings:

### Option 1: Using next-pwa (Current Setup)

The project uses `next-pwa` which wraps Workbox. Configuration is in `next.config.js`:

```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  disable: process.env.NODE_ENV === 'development',
  // Add custom Workbox options here
  runtimeCaching: [
    // Custom caching strategies
  ],
});
```

### Option 2: Custom Service Worker

For stricter security requirements, create a custom service worker:

1. Create `public/custom-sw.js`:
```javascript
// Add origin checking for postMessage
self.addEventListener('message', (event) => {
  // Strict origin check
  if (event.origin !== self.location.origin) {
    console.warn('Rejected message from:', event.origin);
    return;
  }
  // Process message...
});
```

2. Update `next.config.js` to use custom SW

### Option 3: Disable PWA

If PWA functionality is not required:

1. Remove `next-pwa` from dependencies
2. Delete `public/sw.js` and `public/workbox-*.js`
3. Remove PWA configuration from `next.config.js`

---

## Security Best Practices

1. **Keep Workbox Updated**: Regularly update `next-pwa` to get latest Workbox security fixes

2. **CSP Headers**: Ensure Content-Security-Policy restricts script sources:
   ```
   script-src 'self' 'nonce-xxx';
   ```

3. **Service Worker Scope**: The SW is scoped to `/` by default. Consider restricting if needed.

4. **Cache Validation**: Implement cache versioning to prevent stale content attacks.

5. **HTTPS Only**: Service workers only work over HTTPS (except localhost).

---

## Monitoring

- **Workbox Releases**: https://github.com/GoogleChrome/workbox/releases
- **Security Advisories**: https://github.com/GoogleChrome/workbox/security/advisories
- **next-pwa Issues**: https://github.com/shadowwalker/next-pwa/issues

---

## Related Documents

- [GitHub Settings Checklist](./github-settings-checklist.md)
- [CI Security Checks](./ci-security-checks.md)
- [SECURITY.md](../../SECURITY.md)

