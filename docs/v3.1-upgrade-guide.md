# EP Chat DeepSeek v3.1 升级指南

## 🚀 升级概述

**版本**: EP-128K v3.1 (Model Update: DeepSeek-v3.1 + Cost-Guard)  
**发布日期**: 2024-12-28  
**升级类型**: 重大功能升级 + 成本风控

### 核心特性

✅ **模型升级**: 默认使用 DeepSeek-v3.1，支持 131K 上下文窗口  
✅ **能力协商**: 动态探测模型能力，失败时智能回退  
✅ **三级预算守护**: 请求级、用户级、全站级成本控制  
✅ **预算感知续写**: 基于剩余预算的智能续写策略  
✅ **SSE长流稳定**: 支持30-60分钟超长流式生成  
✅ **Prometheus监控**: 完整的成本、性能、错误率监控  
✅ **零回归保障**: 传统功能性能不劣化 >5%  

## 📋 升级前检查清单

### 环境要求
- [ ] Node.js >= 18.0.0
- [ ] Docker >= 20.10.0
- [ ] Docker Compose >= 2.0.0
- [ ] 可用内存 >= 4GB
- [ ] DeepSeek API 密钥有效

### 配置检查
- [ ] `.env` 文件包含所有必需变量
- [ ] API 密钥额度充足
- [ ] Nginx 配置支持长连接
- [ ] 监控系统准备就绪（可选）

## 🔧 升级步骤

### 1. 备份当前部署

```bash
# 创建备份目录
mkdir -p backups/$(date +%Y%m%d-%H%M%S)

# 备份配置文件
cp .env backups/$(date +%Y%m%d-%H%M%S)/
cp docker-compose.yml backups/$(date +%Y%m%d-%H%M%S)/
cp nginx.conf backups/$(date +%Y%m%d-%H%M%S)/ 2>/dev/null || true

# 导出当前容器状态
docker-compose ps --format json > backups/$(date +%Y%m%d-%H%M%S)/containers.json
```

### 2. 更新代码和配置

```bash
# 拉取最新代码
git fetch origin
git checkout feat/model-v3.1-upgrade
git pull origin feat/model-v3.1-upgrade

# 安装新依赖
npm install

# 构建项目
npm run build
```

### 3. 配置环境变量

更新 `.env` 文件，添加 v3.1 相关配置：

```bash
# 复制示例配置
cp .env.example .env

# 编辑配置文件
nano .env
```

**关键配置项**:

```env
# 模型配置
MODEL_NAME=deepseek-v3.1
MODEL_CTX=131072
PRICE_IN_PER_1K=0.0014
PRICE_OUT_PER_1K=0.0028

# 预算控制
BUDGET_REQ_USD=0.40
BUDGET_USER_DAILY_USD=2.50
BUDGET_SITE_HOURLY_USD=8.00

# 特性开关
EP_128K_MODE=enabled
EP_AUTO_CONTINUATION=true
EP_LONG_OUTPUT_GUARD=on
PROM_ENABLED=true
```

### 4. 执行升级测试

```bash
# 运行升级验证测试
npm run test:v3.1:full

# 检查测试结果
ls -la test-results/v3.1-upgrade/
```

### 5. 部署新版本

```bash
# 使用自动化部署脚本
npm run deploy:prod

# 或手动部署
docker-compose down
docker-compose up -d --build

# 检查服务状态
docker-compose ps
docker-compose logs -f --tail=100
```

### 6. 验证部署

```bash
# 健康检查
curl http://localhost:3000/api/generate

# 预算检查
curl -X POST http://localhost:3000/api/preflight \
  -H "Content-Type: application/json" \
  -d '{"model":"deepseek-v3.1","inputTokens":1000,"targetOutputTokens":5000,"userId":"test"}'

# 监控指标
curl http://localhost:3000/api/metrics

# 成本报告
curl http://localhost:3000/api/cost-report
```

## 📊 监控和告警

### Prometheus 指标

关键指标监控：

```yaml
# prometheus.yml 配置示例
scrape_configs:
  - job_name: 'ep-chat'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/api/metrics'
    scrape_interval: 30s
```

### 告警规则

```yaml
# alerts.yml
groups:
  - name: ep-chat
    rules:
      - alert: HighCostPerRequest
        expr: ep_chat_estimated_cost_usd_total / ep_chat_requests_total > 0.40
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "EP Chat request cost too high"

      - alert: BudgetExceeded
        expr: increase(ep_chat_budget_circuit_breaker_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "EP Chat budget limit exceeded"
```

## 🔄 回滚方案

### 自动回滚

```bash
# 回滚到最新备份
npm run rollback -- --latest

# 回滚到指定备份
npm run rollback -- ./backups/20241228-143022

# 紧急回滚（禁用新功能）
npm run rollback -- --emergency
```

### 手动回滚

```bash
# 1. 停止服务
docker-compose down

# 2. 恢复配置
cp backups/20241228-143022/.env .
cp backups/20241228-143022/docker-compose.yml .

# 3. 重启服务
docker-compose up -d

# 4. 验证回滚
curl http://localhost:3000/health
```

## 🧪 测试验证

### 功能测试

```bash
# 基础功能测试
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt":"测试基础功能","model":"deepseek-chat","maxTokens":100}'

# v3.1 功能测试
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt":"测试v3.1功能","model":"deepseek-v3.1","maxTokens":8000,"enableBudgetGuard":true}'
```

### 性能测试

```bash
# 运行压力测试
npm run stress-test:full

# 检查性能指标
curl http://localhost:3000/api/metrics | grep ep_chat_request_duration
```

### 成本测试

```bash
# 测试预算控制
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt":"生成超长内容","model":"deepseek-v3.1","maxTokens":50000,"enableBudgetGuard":true}'

# 应该返回 402 状态码（预算限制）
```

## 📈 性能优化建议

### 1. 内存优化

```bash
# 设置 Node.js 内存限制
export NODE_OPTIONS="--max-old-space-size=4096"

# 启用垃圾回收监控
export NODE_OPTIONS="$NODE_OPTIONS --expose-gc"
```

### 2. 并发优化

```env
# 调整并发限制
RL_MAX_CONCURRENCY_PER_USER=2
RL_MAX_ACTIVE_STREAMS=60
```

### 3. 缓存优化

```env
# 启用能力缓存
MODEL_CAPABILITY_CACHE_TTL=1800

# 启用预算缓存
BUDGET_CACHE_TTL=300
```

## 🚨 故障排除

### 常见问题

**1. 构建失败**
```bash
# 清理缓存重新构建
rm -rf .next node_modules
npm install
npm run build
```

**2. API 超时**
```bash
# 检查 Nginx 配置
nginx -t
docker-compose restart nginx
```

**3. 预算控制异常**
```bash
# 检查环境变量
env | grep BUDGET
docker-compose logs ep-app | grep budget
```

**4. 监控指标缺失**
```bash
# 检查 Prometheus 配置
curl http://localhost:3000/api/metrics
docker-compose logs ep-app | grep prometheus
```

### 日志分析

```bash
# 查看应用日志
docker-compose logs -f ep-app

# 查看 Nginx 日志
docker-compose logs -f nginx

# 查看错误日志
docker-compose logs ep-app | grep ERROR

# 查看成本相关日志
docker-compose logs ep-app | grep -i "budget\|cost"
```

## 📞 支持联系

如遇到升级问题，请提供以下信息：

1. 错误日志 (`docker-compose logs`)
2. 环境配置 (`.env` 文件，隐藏敏感信息)
3. 系统信息 (`docker version`, `node --version`)
4. 测试结果 (`test-results/v3.1-upgrade/`)

---

**升级完成后，请验证所有功能正常运行，并监控系统性能和成本指标。**
