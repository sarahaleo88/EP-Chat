# EP Chat DeepSeek v3.1 å‡çº§æŒ‡å—

## ğŸš€ å‡çº§æ¦‚è¿°

**ç‰ˆæœ¬**: EP-128K v3.1 (Model Update: DeepSeek-v3.1 + Cost-Guard)  
**å‘å¸ƒæ—¥æœŸ**: 2024-12-28  
**å‡çº§ç±»å‹**: é‡å¤§åŠŸèƒ½å‡çº§ + æˆæœ¬é£æ§

### æ ¸å¿ƒç‰¹æ€§

âœ… **æ¨¡å‹å‡çº§**: é»˜è®¤ä½¿ç”¨ DeepSeek-v3.1ï¼Œæ”¯æŒ 131K ä¸Šä¸‹æ–‡çª—å£  
âœ… **èƒ½åŠ›åå•†**: åŠ¨æ€æ¢æµ‹æ¨¡å‹èƒ½åŠ›ï¼Œå¤±è´¥æ—¶æ™ºèƒ½å›é€€  
âœ… **ä¸‰çº§é¢„ç®—å®ˆæŠ¤**: è¯·æ±‚çº§ã€ç”¨æˆ·çº§ã€å…¨ç«™çº§æˆæœ¬æ§åˆ¶  
âœ… **é¢„ç®—æ„ŸçŸ¥ç»­å†™**: åŸºäºå‰©ä½™é¢„ç®—çš„æ™ºèƒ½ç»­å†™ç­–ç•¥  
âœ… **SSEé•¿æµç¨³å®š**: æ”¯æŒ30-60åˆ†é’Ÿè¶…é•¿æµå¼ç”Ÿæˆ  
âœ… **Prometheusç›‘æ§**: å®Œæ•´çš„æˆæœ¬ã€æ€§èƒ½ã€é”™è¯¯ç‡ç›‘æ§  
âœ… **é›¶å›å½’ä¿éšœ**: ä¼ ç»ŸåŠŸèƒ½æ€§èƒ½ä¸åŠ£åŒ– >5%  

## ğŸ“‹ å‡çº§å‰æ£€æŸ¥æ¸…å•

### ç¯å¢ƒè¦æ±‚
- [ ] Node.js >= 18.0.0
- [ ] Docker >= 20.10.0
- [ ] Docker Compose >= 2.0.0
- [ ] å¯ç”¨å†…å­˜ >= 4GB
- [ ] DeepSeek API å¯†é’¥æœ‰æ•ˆ

### é…ç½®æ£€æŸ¥
- [ ] `.env` æ–‡ä»¶åŒ…å«æ‰€æœ‰å¿…éœ€å˜é‡
- [ ] API å¯†é’¥é¢åº¦å……è¶³
- [ ] Nginx é…ç½®æ”¯æŒé•¿è¿æ¥
- [ ] ç›‘æ§ç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼ˆå¯é€‰ï¼‰

## ğŸ”§ å‡çº§æ­¥éª¤

### 1. å¤‡ä»½å½“å‰éƒ¨ç½²

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backups/$(date +%Y%m%d-%H%M%S)

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp .env backups/$(date +%Y%m%d-%H%M%S)/
cp docker-compose.yml backups/$(date +%Y%m%d-%H%M%S)/
cp nginx.conf backups/$(date +%Y%m%d-%H%M%S)/ 2>/dev/null || true

# å¯¼å‡ºå½“å‰å®¹å™¨çŠ¶æ€
docker-compose ps --format json > backups/$(date +%Y%m%d-%H%M%S)/containers.json
```

### 2. æ›´æ–°ä»£ç å’Œé…ç½®

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git fetch origin
git checkout feat/model-v3.1-upgrade
git pull origin feat/model-v3.1-upgrade

# å®‰è£…æ–°ä¾èµ–
npm install

# æ„å»ºé¡¹ç›®
npm run build
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

æ›´æ–° `.env` æ–‡ä»¶ï¼Œæ·»åŠ  v3.1 ç›¸å…³é…ç½®ï¼š

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env
```

**å…³é”®é…ç½®é¡¹**:

```env
# æ¨¡å‹é…ç½®
MODEL_NAME=deepseek-v3.1
MODEL_CTX=131072
PRICE_IN_PER_1K=0.0014
PRICE_OUT_PER_1K=0.0028

# é¢„ç®—æ§åˆ¶
BUDGET_REQ_USD=0.40
BUDGET_USER_DAILY_USD=2.50
BUDGET_SITE_HOURLY_USD=8.00

# ç‰¹æ€§å¼€å…³
EP_128K_MODE=enabled
EP_AUTO_CONTINUATION=true
EP_LONG_OUTPUT_GUARD=on
PROM_ENABLED=true
```

### 4. æ‰§è¡Œå‡çº§æµ‹è¯•

```bash
# è¿è¡Œå‡çº§éªŒè¯æµ‹è¯•
npm run test:v3.1:full

# æ£€æŸ¥æµ‹è¯•ç»“æœ
ls -la test-results/v3.1-upgrade/
```

### 5. éƒ¨ç½²æ–°ç‰ˆæœ¬

```bash
# ä½¿ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
npm run deploy:prod

# æˆ–æ‰‹åŠ¨éƒ¨ç½²
docker-compose down
docker-compose up -d --build

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
docker-compose logs -f --tail=100
```

### 6. éªŒè¯éƒ¨ç½²

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/generate

# é¢„ç®—æ£€æŸ¥
curl -X POST http://localhost:3000/api/preflight \
  -H "Content-Type: application/json" \
  -d '{"model":"deepseek-v3.1","inputTokens":1000,"targetOutputTokens":5000,"userId":"test"}'

# ç›‘æ§æŒ‡æ ‡
curl http://localhost:3000/api/metrics

# æˆæœ¬æŠ¥å‘Š
curl http://localhost:3000/api/cost-report
```

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### Prometheus æŒ‡æ ‡

å…³é”®æŒ‡æ ‡ç›‘æ§ï¼š

```yaml
# prometheus.yml é…ç½®ç¤ºä¾‹
scrape_configs:
  - job_name: 'ep-chat'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/api/metrics'
    scrape_interval: 30s
```

### å‘Šè­¦è§„åˆ™

```yaml
# alerts.yml
groups:
  - name: ep-chat
    rules:
      - alert: HighCostPerRequest
        expr: ep_chat_estimated_cost_usd_total / ep_chat_requests_total > 0.40
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "EP Chat request cost too high"

      - alert: BudgetExceeded
        expr: increase(ep_chat_budget_circuit_breaker_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "EP Chat budget limit exceeded"
```

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

### è‡ªåŠ¨å›æ»š

```bash
# å›æ»šåˆ°æœ€æ–°å¤‡ä»½
npm run rollback -- --latest

# å›æ»šåˆ°æŒ‡å®šå¤‡ä»½
npm run rollback -- ./backups/20241228-143022

# ç´§æ€¥å›æ»šï¼ˆç¦ç”¨æ–°åŠŸèƒ½ï¼‰
npm run rollback -- --emergency
```

### æ‰‹åŠ¨å›æ»š

```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. æ¢å¤é…ç½®
cp backups/20241228-143022/.env .
cp backups/20241228-143022/docker-compose.yml .

# 3. é‡å¯æœåŠ¡
docker-compose up -d

# 4. éªŒè¯å›æ»š
curl http://localhost:3000/health
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•

```bash
# åŸºç¡€åŠŸèƒ½æµ‹è¯•
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt":"æµ‹è¯•åŸºç¡€åŠŸèƒ½","model":"deepseek-chat","maxTokens":100}'

# v3.1 åŠŸèƒ½æµ‹è¯•
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt":"æµ‹è¯•v3.1åŠŸèƒ½","model":"deepseek-v3.1","maxTokens":8000,"enableBudgetGuard":true}'
```

### æ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œå‹åŠ›æµ‹è¯•
npm run stress-test:full

# æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
curl http://localhost:3000/api/metrics | grep ep_chat_request_duration
```

### æˆæœ¬æµ‹è¯•

```bash
# æµ‹è¯•é¢„ç®—æ§åˆ¶
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt":"ç”Ÿæˆè¶…é•¿å†…å®¹","model":"deepseek-v3.1","maxTokens":50000,"enableBudgetGuard":true}'

# åº”è¯¥è¿”å› 402 çŠ¶æ€ç ï¼ˆé¢„ç®—é™åˆ¶ï¼‰
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å†…å­˜ä¼˜åŒ–

```bash
# è®¾ç½® Node.js å†…å­˜é™åˆ¶
export NODE_OPTIONS="--max-old-space-size=4096"

# å¯ç”¨åƒåœ¾å›æ”¶ç›‘æ§
export NODE_OPTIONS="$NODE_OPTIONS --expose-gc"
```

### 2. å¹¶å‘ä¼˜åŒ–

```env
# è°ƒæ•´å¹¶å‘é™åˆ¶
RL_MAX_CONCURRENCY_PER_USER=2
RL_MAX_ACTIVE_STREAMS=60
```

### 3. ç¼“å­˜ä¼˜åŒ–

```env
# å¯ç”¨èƒ½åŠ›ç¼“å­˜
MODEL_CAPABILITY_CACHE_TTL=1800

# å¯ç”¨é¢„ç®—ç¼“å­˜
BUDGET_CACHE_TTL=300
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. æ„å»ºå¤±è´¥**
```bash
# æ¸…ç†ç¼“å­˜é‡æ–°æ„å»º
rm -rf .next node_modules
npm install
npm run build
```

**2. API è¶…æ—¶**
```bash
# æ£€æŸ¥ Nginx é…ç½®
nginx -t
docker-compose restart nginx
```

**3. é¢„ç®—æ§åˆ¶å¼‚å¸¸**
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
env | grep BUDGET
docker-compose logs ep-app | grep budget
```

**4. ç›‘æ§æŒ‡æ ‡ç¼ºå¤±**
```bash
# æ£€æŸ¥ Prometheus é…ç½®
curl http://localhost:3000/api/metrics
docker-compose logs ep-app | grep prometheus
```

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs -f ep-app

# æŸ¥çœ‹ Nginx æ—¥å¿—
docker-compose logs -f nginx

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose logs ep-app | grep ERROR

# æŸ¥çœ‹æˆæœ¬ç›¸å…³æ—¥å¿—
docker-compose logs ep-app | grep -i "budget\|cost"
```

## ğŸ“ æ”¯æŒè”ç³»

å¦‚é‡åˆ°å‡çº§é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. é”™è¯¯æ—¥å¿— (`docker-compose logs`)
2. ç¯å¢ƒé…ç½® (`.env` æ–‡ä»¶ï¼Œéšè—æ•æ„Ÿä¿¡æ¯)
3. ç³»ç»Ÿä¿¡æ¯ (`docker version`, `node --version`)
4. æµ‹è¯•ç»“æœ (`test-results/v3.1-upgrade/`)

---

**å‡çº§å®Œæˆåï¼Œè¯·éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œï¼Œå¹¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½å’Œæˆæœ¬æŒ‡æ ‡ã€‚**
